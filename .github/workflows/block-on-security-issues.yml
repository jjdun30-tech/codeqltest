name: Block on open "security" issues

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  gate:
    name: security-issue-gate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fail if open 'security' Issues are associated with this PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          PR_NUM="${{ github.event.pull_request.number }}"
          PR_URL="${{ github.event.pull_request.html_url }}"

          # 1) Pull open issues with the 'security' label (no Search API)
          gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/$REPO/issues" \
            -f state=open \
            -f labels=security \
            -f per_page=100 > issues.json

          # 2) See if any of those issues mention this PR (either "PR #<num>" or its URL)
          count=$(jq --arg prnum "$PR_NUM" --arg prurl "$PR_URL" '
            [ .[] |
              select(
                ((.title // "")     | test("PR #"+$prnum))
                or
                ((.body // "")      | test("PR #"+$prnum))
                or
                ((.title // "")     | contains($prurl))
                or
                ((.body // "")      | contains($prurl))
              )
            ] | length
          ' issues.json)

          echo "Open 'security' issues associated with this PR: $count"
          if [ "$count" -gt 0 ]; then
            echo "::error title=Blocking security issue(s) found::There are open Issue(s) labeled 'security' associated with this PR."
            exit 1
          fi

          echo "No open 'security' Issues associated with this PR."
